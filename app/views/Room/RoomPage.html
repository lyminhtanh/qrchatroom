{{set . "title" "Chat room"}}
{{template "header.html" .}}

<h2>Room <strong>{{.chatroom.RoomName}}</strong> </h2>
  <a href="/" class="float-lg-right" id="leave">Leave the chat room</a></h2>

<div class="container">


<div id="thread" class="row">
  <script type="text/html" id="message_tmpl">
    {{raw "<%"}} if(event.Type == 'MESSAGE') { %>
    <div class="message <%= event.Device == '{{.device}}' ? 'you' : '' %>">
      <h4 class="font-italic">Device: {{raw "<%"}}= event.Device %></h4>
      <p class="">
        {{raw "<%"}}= event.Message %>
      </p>
    </div>
    {{raw "<%"}} } %>
    {{raw "<%"}} if(event.Type == 'JOIN') { %>
    <div class="message notice">
      <h2></h2>
      <p>
        <strong>{{raw "<%"}}= event.Device %></strong> has joined the room
      </p>
    </div>
    {{raw "<%"}} } %>
    {{raw "<%"}} if(event.Type == 'LEAVE') { %>
    <div class="message notice">
      <h2></h2>
      <p>
        {{raw "<%"}}= event.Device  %> left the room
      </p>
    </div>
    {{raw "<%"}} } %>
    {{raw "<%"}} if(event.Type == 'quit') { %>
    <div class="message important">
      <h2></h2>
      <p>
        You are now disconnected!
      </p>
    </div>
    {{raw "<%"}} } %>
  </script>
</div>

<div id="newMessage" class="col-lg-6">
  <input type="text" id="message" autocomplete="off" autofocus>
  <input type="submit" value="send" class="btn btn-danger" id="send">
</div>

<div class="row">
  <h2>Your new room URL:</h2>
  <div>
    <a href={{.chatroom.RoomAddr}} target="_blank">
      {{.chatroom.RoomAddr}}</a>

    <img src={{.chatroom.QrCodeUrl}}
         alt="qr" />
  </div>
</div>
</div>
<script type="text/javascript">

  // Create a socket
  var socket = new WebSocket('ws://'+window.location.host+'/ws/room?roomName={{.chatroom.RoomName}}&device={{.device}}')

  // Display a message
  var display = function(event) {
    $('#thread').append(tmpl('message_tmpl', {event: event}));
    $('#thread').scrollTo('max')
  }

  // Message received on the socket
  socket.onmessage = function(event) {
    display(JSON.parse(event.data))
  }

  $('#send').click(function(e) {
    var message = {
      Type: 'MESSAGE',
      Device: {{.device}},
      Timestamp: null,
      Message: $('#message').val()
    }

    $('#message').val('')
    socket.send(JSON.stringify(message))
  });
  $('#leave').click(function(e) {

    var message = {
      Type: 'LEAVE',
      Device: {{.device}},
      Timestamp: null,
      Message: $('#message').val()
    }
    socket.send(JSON.stringify(message))
  });

  $('#message').keypress(function(e) {
    if(e.charCode == 13 || e.keyCode == 13) {
      $('#send').click()
      e.preventDefault()
    }
  })

</script>
